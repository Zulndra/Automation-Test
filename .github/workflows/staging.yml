name: Staging - Full CI/CD

on:
  push:
    branches: [ develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  issues: write
  pull-requests: write

jobs:
  # ==========================================
  # JOB 1: TESTING
  # ==========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci

      - name: üß™ Run tests
        id: test
        run: |
          set -o pipefail
          npm test 2>&1 | tee test.log

      - name: üì§ Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: test.log
      
      - name: ‚úÖ Tests result
        if: always()
        run: |
          if [ "${{ steps.test.outcome }}" = "failure" ]; then
            echo "‚ùå Tests failed!"
            exit 1
          else
            echo "‚úÖ All tests passed!"
          fi

  # ==========================================
  # JOB 2: BUILD & PUSH DOCKER IMAGE
  # ==========================================
  build-and-push:
    name: Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: üîë Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=staging-latest
      
      - name: üèóÔ∏è Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # JOB 3: DEPLOY TO STAGING
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: üöÄ Deploy to Staging
        run: |
          echo "Deploying to staging..."
          echo "‚úÖ Deployment completed!"

  # ==========================================
  # JOB 4: SUCCESS NOTIFICATION
  # ==========================================
  notify-success:
    name: Success Notification
    needs: [test, build-and-push, deploy-staging]
    runs-on: ubuntu-latest
    if: |
      needs.test.result == 'success' &&
      needs.build-and-push.result == 'success' &&
      needs.deploy-staging.result == 'success'
    
    steps:
      - name: ‚úÖ Discord Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'success'
          title: "üöÄ Staging Deployment Successful"
          description: |
            **Deployment completed successfully!**

            **Environment:** `staging`  
            **Branch:** `${{ github.ref_name }}`  
            **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
            **Triggered by:** `${{ github.actor }}`

            üîó **Actions Run:**  
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0x2ecc71
          username: "CI/CD Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"


  # ==========================================
  # JOB 5: FAILURE HANDLER (MAIN JOB)
  # ==========================================
  handle-failure:
    name: Handle Failure
    needs: [test, build-and-push, deploy-staging]
    runs-on: ubuntu-latest
    if: failure()

    permissions:
      issues: write
      contents: read

    steps:
      - name: Detect failed job
        id: detect
        run: |
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "job=test" >> $GITHUB_OUTPUT
            echo "log=test-log/test.log" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build-and-push.result }}" = "failure" ]; then
            echo "job=build" >> $GITHUB_OUTPUT
            echo "log=build-log/build.log" >> $GITHUB_OUTPUT
          else
            echo "job=deploy" >> $GITHUB_OUTPUT
            echo "log=deploy-log/deploy.log" >> $GITHUB_OUTPUT
          fi

      - uses: actions/download-artifact@v4

      - name: Read log
        id: log
        run: |
          FILE="${{ steps.detect.outputs.log }}"
          if [ -f "$FILE" ]; then
            tail -n 80 "$FILE" > error.log
          else
            echo "No log file found." > error.log
          fi

      - name: Create GitHub Issue
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const log = fs.readFileSync('error.log', 'utf8')

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® CI Failure ‚Ä¢ Run #${context.runNumber}`,
              body: `
            ## ‚ùå CI/CD Pipeline Failure

            **Workflow** : ${context.workflow}  
            **Failed Job** : **${process.env.FAILED_JOB || 'Unknown'}**  
            **Branch** : \`${context.ref.replace('refs/heads/', '')}\`  
            **Commit** : [\`${context.sha.substring(0,7)}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})  
            **Triggered by** : @${context.actor}

            ---

            ## üìÑ Error Log (Preview)
            <details>
            <summary>Click to expand</summary>

            \`\`\`
            ${log.substring(0, 1500)}
            \`\`\`

            </details>

            ---

            ## üîó Useful Links
            - üîç **GitHub Actions Logs**  
              https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            - üßæ **Full Log**  
              Available in Discord thread

            ---

            ‚ö†Ô∏è *This issue was automatically generated by CI/CD pipeline.*
            `,
              labels: ['ci', 'bug', 'automation']
            })

            core.setOutput('url', issue.data.html_url)


      - name: Send Discord message + create thread + post log
        run: |
          LOG=$(sed 's/"/\\"/g' error.log)

          MSG=$(curl -s -X POST \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üö® **CI FAILURE**\\nJob: **${{ steps.detect.outputs.job }}**\\nIssue: ${{ steps.issue.outputs.url }}\"
            }")

          MID=$(echo "$MSG" | jq -r '.id')

          THREAD=$(curl -s -X POST \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages/$MID/threads" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{ \"name\": \"‚ùå CI Failure #${{ github.run_number }}\" }")

          TID=$(echo "$THREAD" | jq -r '.id')

          curl -X POST \
            "https://discord.com/api/v10/channels/$TID/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{ \"content\": \"\`\`\`\n$LOG\n\`\`\`\" }"

  # ==========================================
  # JOB 6: PULL REQUEST NOTIFICATION
  # ==========================================
  pull_request:
    name: Pull Request Notification

    on:
      pull_request:
        types: [opened, reopened, ready_for_review]

    jobs:
      notify-pr:
        name: Notify New Pull Request
        runs-on: ubuntu-latest

        steps:
          - name: üì¢ Discord PR Notification
            uses: sarisia/actions-status-discord@v1
            with:
              webhook: ${{ secrets.DISCORD_WEBHOOK }}
              status: 'info'
              title: "üîÄ New Pull Request"
              description: |
                **${{ github.event.pull_request.title }}**

                **Repository:** `${{ github.repository }}`
                **Author:** `${{ github.actor }}`
                **Source:** `${{ github.event.pull_request.head.ref }}`
                **Target:** `${{ github.event.pull_request.base.ref }}`

                üìù **Description**
                ${{ github.event.pull_request.body || 'No description provided.' }}

                üîó **Pull Request URL**
                ${{ github.event.pull_request.html_url }}
              color: 0x3498db
              username: "PR Bot"
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
