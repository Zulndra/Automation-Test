name: Staging - Full CI/CD

on:
  push:
    branches: [ develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  issues: write
  pull-requests: write

jobs:
  # ==========================================
  # JOB 1: TESTING
  # ==========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci

      - name: üß™ Run tests
        id: test
        run: |
          set -o pipefail
          npm test 2>&1 | tee test.log

      - name: üì§ Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: test.log
      
      - name: ‚úÖ Tests result
        if: always()
        run: |
          if [ "${{ steps.test.outcome }}" = "failure" ]; then
            echo "‚ùå Tests failed!"
            exit 1
          else
            echo "‚úÖ All tests passed!"
          fi

  # ==========================================
  # JOB 2: BUILD & PUSH DOCKER IMAGE
  # ==========================================
  build-and-push:
    name: Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: üîë Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=staging-latest
      
      - name: üèóÔ∏è Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # JOB 3: DEPLOY TO STAGING
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: üöÄ Deploy to Staging
        run: |
          echo "Deploying to staging..."
          echo "‚úÖ Deployment completed!"

  # ==========================================
  # JOB 4: SUCCESS NOTIFICATION
  # ==========================================
  notify-success:
    name: Success Notification
    needs: [test, build-and-push, deploy-staging]
    runs-on: ubuntu-latest
    if: |
      needs.test.result == 'success' &&
      needs.build-and-push.result == 'success' &&
      needs.deploy-staging.result == 'success'
    
    steps:
      - name: ‚úÖ Discord Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'success'
          title: "Staging Deployment"
          description: "‚úÖ Deployed successfully!"
          color: 0x00ff00

  # ==========================================
  # JOB 5: FAILURE HANDLER (MAIN JOB)
  # ==========================================
  handle-failure:
    name: Handle Failure
    needs: [test, build-and-push, deploy-staging]
    runs-on: ubuntu-latest
    if: failure()  # Simple: jalan kalau ada job yang fail
    
    permissions:
      issues: write
      contents: read
    
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}
      issue-url: ${{ steps.create-issue.outputs.issue-url }}
      discord-message-id: ${{ steps.discord-initial.outputs.message-id }}
      failed-job: ${{ steps.detect.outputs.failed_job }}
    
    steps:
      # Step 1: Detect failed job
      - name: üîç Detect failed job
        id: detect
        run: |
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "failed_job=TEST" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build-and-push.result }}" = "failure" ]; then
            echo "failed_job=BUILD" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-staging.result }}" = "failure" ]; then
            echo "failed_job=DEPLOY" >> $GITHUB_OUTPUT
          fi
      
      # Step 2: Download artifacts (logs)
      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      # Step 3: Prepare error log
      - name: üìù Prepare error log
        id: prepare-log
        run: |
          FAILED_JOB="${{ steps.detect.outputs.failed_job }}"
          
          if [ -f "test-log/test.log" ]; then
            LOG_CONTENT=$(tail -n 50 "test-log/test.log")
          else
            LOG_CONTENT="No log file available. Check GitHub Actions logs."
          fi
          
          echo "$LOG_CONTENT" > error.log
      
      # Step 4: Create GitHub Issue
      - name: üêû Create GitHub Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const failedJob = '${{ steps.detect.outputs.failed_job }}';
            const errorLog = fs.readFileSync('error.log', 'utf8');
            
            const title = `‚ùå CI Failure (${failedJob}) - ${context.ref.replace('refs/heads/', '')}`;
            const body = `### üö® CI/CD Pipeline Failure
            
            **Workflow:** ${context.workflow}
            **Failed Job:** ${failedJob}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            **Commit:** [\`${context.sha.substring(0, 7)}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})
            **Author:** @${context.actor}
            
            ---
            
            ### üìÑ Error Log Preview
            \`\`\`
            ${errorLog.substring(0, 500)}...
            \`\`\`
            
            [See full error log in Discord thread]
            
            ---
            
            ### üîó Links
            - [View Full Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [View Commit](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci', 'bug', 'automation', 'staging']
            });
            
            core.setOutput('issue-number', issue.data.number);
            core.setOutput('issue-url', issue.data.html_url);
            console.log(`‚úÖ Issue created: #${issue.data.number}`);
      
      # Step 5: Post initial message to Discord (ini yang akan jadi thread)
      - name: üì¢ Post to Discord (Initial Message)
        id: discord-initial
        run: |
          FAILED_JOB="${{ steps.detect.outputs.failed_job }}"
          ISSUE_NUMBER="${{ steps.create-issue.outputs.issue-number }}"
          ISSUE_URL="${{ steps.create-issue.outputs.issue-url }}"
          
          # Post message dan simpan message ID untuk create thread
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üö® **CI/CD Failure Detected**\",
              \"embeds\": [{
                \"title\": \"‚ùå ${FAILED_JOB} Failed - Staging\",
                \"description\": \"A failure occurred in the CI/CD pipeline.\",
                \"color\": 15158332,
                \"fields\": [
                  {
                    \"name\": \"üìã GitHub Issue\",
                    \"value\": \"[#${ISSUE_NUMBER}](${ISSUE_URL})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üåø Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üë§ Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üíª Commit\",
                    \"value\": \"[\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"üîó Logs\",
                    \"value\": \"[View Full Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}?wait=true)
          
          # Extract message ID dari response
          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "message-id=$MESSAGE_ID" >> $GITHUB_OUTPUT
          echo "Discord message ID: $MESSAGE_ID"
  
  # ==========================================
  # JOB 6: CREATE DISCORD THREAD & POST LOGS
  # ==========================================
  create-discord-thread:
    name: Create Discord Thread
    needs: [handle-failure]
    runs-on: ubuntu-latest
    if: always() && needs.handle-failure.result == 'success'
    
    steps:
      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: üìù Read error log
        id: read-log
        run: |
          if [ -f "test-log/test.log" ]; then
            LOG_CONTENT=$(cat "test-log/test.log")
          else
            LOG_CONTENT="No detailed log available."
          fi
          
          # Save to file untuk dipakai di curl
          echo "$LOG_CONTENT" > full-error.log
      
      - name: üßµ Create Thread & Post Logs
        run: |
          MESSAGE_ID="${{ needs.handle-failure.outputs.discord-message-id }}"
          FAILED_JOB="${{ needs.handle-failure.outputs.failed-job }}"
          ISSUE_NUMBER="${{ needs.handle-failure.outputs.issue-number }}"
          
          # Extract webhook ID and token dari webhook URL
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK }}"
          WEBHOOK_ID=$(echo "$WEBHOOK_URL" | sed -n 's/.*webhooks\/\([0-9]*\)\/.*/\1/p')
          WEBHOOK_TOKEN=$(echo "$WEBHOOK_URL" | sed -n 's/.*webhooks\/[0-9]*\/\(.*\)/\1/p')
          
          echo "Creating thread for message: $MESSAGE_ID"
          
          # Create thread menggunakan Discord API
          THREAD_RESPONSE=$(curl -s -X POST \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages/${MESSAGE_ID}/threads" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"üêõ Issue #${ISSUE_NUMBER} - ${FAILED_JOB} Failure\",
              \"auto_archive_duration\": 1440
            }")
          
          THREAD_ID=$(echo "$THREAD_RESPONSE" | jq -r '.id')
          echo "Thread created: $THREAD_ID"
          
          # Baca error log
          ERROR_LOG=$(cat full-error.log)
          
          # Post full error log ke thread
          # Split jadi chunks kalau terlalu panjang (Discord limit 2000 chars)
          echo "$ERROR_LOG" | fold -w 1900 -s | while read -r chunk; do
            curl -X POST \
              "https://discord.com/api/v10/channels/${THREAD_ID}/messages" \
              -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"content\": \"### üìÑ Error Log\n\`\`\`\n${chunk}\n\`\`\`\"
              }"
            sleep 1
          done
          
          # Post additional info
          curl -X POST \
            "https://discord.com/api/v10/channels/${THREAD_ID}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"üìä Debugging Info\",
                \"color\": 3447003,
                \"fields\": [
                  {
                    \"name\": \"Failed Job\",
                    \"value\": \"${FAILED_JOB}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"GitHub Issue\",
                    \"value\": \"[#${ISSUE_NUMBER}](${{ needs.handle-failure.outputs.issue-url }})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Actions\",
                    \"value\": \"[View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                    \"inline\": false
                  }
                ]
              }]
            }"
          
          echo "‚úÖ Thread created and logs posted!"