name: Production - Full CI/CD

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  issues: write
  pull-requests: write

jobs:
  # ==========================================
  # JOB 1: TESTING
  # ==========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: npm

      - run: npm ci

      - name: üß™ Run tests
        id: test
        run: |
          set -o pipefail
          npm test 2>&1 | tee test.log

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-log
          path: test.log

      - if: always()
        run: |
          [ "${{ steps.test.outcome }}" = "failure" ] && exit 1 || true

  # ==========================================
  # JOB 2: BUILD & PUSH IMAGE
  # ==========================================
  build-and-push:
    name: Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=production-latest
            type=sha

      - uses: docker/build-push-action@v4
        with:
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ==========================================
  # JOB 3: MANUAL APPROVAL
  # ==========================================
  approve-production:
    name: ‚è∏Ô∏è Await Production Approval
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production

    steps:
      - run: echo "Waiting for manual approval..."

  # ==========================================
  # JOB 4: DEPLOY PRODUCTION
  # ==========================================
  deploy-production:
    name: Deploy to Production
    needs: approve-production
    runs-on: ubuntu-latest

    steps:
      - run: |
          echo "üöÄ Deploying to production..."
          echo "‚úÖ Deployment completed"

  # ==========================================
  # JOB 5: SUCCESS NOTIFICATION
  # ==========================================
  notify-success:
    name: Success Notification
    needs: [test, build-and-push, deploy-production]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "üöÄ Production Deployment Successful"
          description: |
            **Environment:** `production`
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            **Approved & deployed successfully**

            üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0x27ae60
          username: "CI/CD Bot"

  # ==========================================
  # JOB 6: FAILURE HANDLER + THREAD
  # ==========================================
  handle-failure:
    name: Handle Failure
    needs: [test, build-and-push, deploy-production]
    runs-on: ubuntu-latest
    if: failure()

    permissions:
      issues: write
      contents: read

    steps:
      - id: detect
        run: |
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "job=test" >> $GITHUB_OUTPUT
            echo "log=test-log/test.log" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build-and-push.result }}" = "failure" ]; then
            echo "job=build" >> $GITHUB_OUTPUT
          else
            echo "job=deploy" >> $GITHUB_OUTPUT
          fi

      - uses: actions/download-artifact@v4

      - run: |
          FILE="${{ steps.detect.outputs.log }}"
          [ -f "$FILE" ] && tail -n 80 "$FILE" > error.log || echo "No log" > error.log

      - id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const log = fs.readFileSync('error.log', 'utf8')

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production CI Failure #${context.runNumber}`,
              body: `\`\`\`\n${log}\n\`\`\`\nhttps://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['ci','bug','production']
            })

            core.setOutput('url', issue.data.html_url)

      - name: Discord Message + Thread + Log
        run: |
          LOG=$(sed 's/"/\\"/g' error.log)

          MSG=$(curl -s -X POST \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üö® **PRODUCTION FAILURE**\nJob: **${{ steps.detect.outputs.job }}**\nIssue: ${{ steps.issue.outputs.url }}\"
            }")

          MID=$(echo "$MSG" | jq -r '.id')

          THREAD=$(curl -s -X POST \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages/$MID/threads" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{ \"name\": \"‚ùå Production Failure #${{ github.run_number }}\" }")

          TID=$(echo "$THREAD" | jq -r '.id')

          curl -X POST \
            "https://discord.com/api/v10/channels/$TID/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{ \"content\": \"\`\`\`\n$LOG\n\`\`\`\" }"
